---
title: "STAT-401 Group Project"
output: html_notebook
---

 

```{r}

library(ggplot2)
library(data.table)
library(ggplot2)
library(gganimate)
library(transformr)
library(dplyr)
library(tidyverse)
library(scales)

#Cases from JLU
confirmed_cases_US <- "https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"
confirmed_cases_US <- read.csv(confirmed_cases_US)
#Deaths from JLU
deaths_US <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv"
deaths_US <- read.csv(deaths_US)

owid_vaccines <- "https://raw.githubusercontent.com/owid/covid-19-data/13ee5b4126177156fba70fada48f7905da60e9c4/public/data/vaccinations/us_state_vaccinations.csv"
owid_vaccines <- read.csv(owid_vaccines)


```


```{r}

vaccines_time = owid_vaccines %>% select("date"| "location" | "people_vaccinated")
head(vaccines_time)



cases = confirmed_cases_US %>% select("Province_State" | starts_with("X"))
deaths = deaths_US %>% select("Province_State" | starts_with("X"))


cases = cases %>% group_by(Province_State) %>% summarise(across(starts_with("X"), sum))
deaths = deaths %>% group_by(Province_State) %>% summarise(across(starts_with("X"), sum))

setDT(cases)
cases = cases %>% melt(cases, id=c("Province_State"), measure=patterns("^X"), value.name="Cases", variable.name="Date")

setDT(deaths)
deaths = deaths %>% melt(deaths, id=c("Province_State"), measure=patterns("^X"), value.name="Deaths", variable.name="Date")

cases$Date = as.Date(cases$Date, format="X%m.%d.%y")
deaths$Date = as.Date(deaths$Date, format="X%m.%d.%y")
covid <- merge(cases, deaths, by=c("Province_State", "Date"))

state = "Maryland"
state_covid = covid %>% filter(Province_State == state)

#reshape data from 'wide' to 'long' for princess ggplot 
state_covid = state_covid %>% pivot_longer(cols= c(Deaths, Cases), names_to = "Type")
head(state_covid)

vaccines_time$date = as.Date(vaccines_time$date)   
state_vax = vaccines_time %>% filter(location == state)
head(state_vax)

```


```{r}
theme_set(theme_gray())



death_plot <- ggplot(data = state_covid, aes(x = Date,y = value , fill = Type)) +
  labs(title = "Covid Cases and Deaths in Maryland"  ) +
  geom_area(alpha = .65)  +
  scale_y_continuous(name = "Number of Cases/Deaths", labels = comma) +
  scale_fill_manual(values = c('orange','red'))
death_plot
death_plot + transition_reveal(Date)
```



```{r}

vax_plot <- ggplot(data = state_vax, aes(x = date, y = people_vaccinated)) +
  labs(title = "Covid Vaccines in Maryland"  ) +
    geom_area( fill="darkblue", alpha = 0.67) 
    
vax_plot
vax_plot + transition_reveal(date) 

```


```{r}
#Let's do a hypothesis test of a population proportion:
#First get the data from the latest day as of (4-16)
deaths <- state_covid[[901,4]]
cases <- state_covid[[902,4]]
deaths
cases
```

We test the null hypothesis for the population parameter $p$ which represents the proportion of deaths out of cases.
Using the assumption that death represents 1% of cases, we have $H_0:p=0.01$ vs $H_a:p\neq0.01 $. 
This means we will use a two-tailed test.
$ n\cdot p_0 = 433359 \cdot 0.01 = 4333.59 > 10$ and $n \cdot q_0 = 433359 \cdot .99 = 429025.4 > 10$ So we can use a large sample Z-test.

```{r}
#calculate the Z-stat
calc_z_stat <- function(p_hat, p_0, n){
  return((p_hat-p_0)/sqrt(((p_0*(1-p_0))/n)))
}

p_hat = deaths/cases
p_hat #This is an unbiased estimator for the proportion of deaths
z_stat <- calc_z_stat(p_hat, 0.01, cases)
z_stat
2*(pnorm(abs(z_stat), lower.tail = FALSE)) 


```
However, we reject the null hypothesis a little too conclusively. Lets find a suitable sample size for $a = 0.01$ and $b = 0.05$ 
with $p' = 0.019$ (close to the $\hat{p}$ we calculated earlier)

```{r}
calc_samp_size <- function(alpha, p_0, beta, p_prime) {
  z_a <- qnorm(alpha, lower.tail = FALSE)
  z_b <- qnorm(beta, lower.tail = FALSE)
  return(( (z_a*sqrt(p_0*(1-p_0)) + z_b*sqrt(p_prime*(1-p_prime)))/(p_prime - p_0))^2 )
}

n <- ceiling(calc_samp_size(0.01, 0.01, 0.05, 0.019))
n
```
So we need a sample size of 2568.
Assuming that covid deaths are contained within cases, lets sample from our current sample at the appropriate sample size.
```{r}

#make a vector to sample from
#433359 - 8528 = 424831
x <- c(replicate(424831,0),replicate(8528,1))

mean(x) #matches p_hat

#sample the sample
set.seed(0)
samp <- sample(x,n)
mean(samp)

#calc z test (again) this time with an upper tailed test
z_stat <- calc_z_stat(mean(samp), 0.01, n)
z_stat
pnorm(z_stat, lower.tail = FALSE)

```
Once again we reject the null hypothesis.